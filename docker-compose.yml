services:
  anubis_django_blue:
    image: ghcr.io/techarohq/anubis:latest
    environment:
      BIND: ":8000"
      DIFFICULTY: "3"
      METRICS_BIND: ":9010"
      TARGET: "http://django_blue:8000"
      OG_PASSTHROUGH: "true"
      USE_REMOTE_ADDRESS: "true"
    ports:
      - 8000:8000
    volumes:
      - "./botPolicy.yaml:/data/cfg/botPolicy.yaml:ro"
  django_blue:
    image: ghcr.io/civicband/corkboard:${VERSION:-latest}
    # Code is baked into the image - no local build or volume mount
    volumes:
      # Only mount data, not code
      - ../sites:/sites/
      - ./sites.db:/app/sites.db:ro
    env_file:
      - .env
    environment:
      - DJANGO_SETTINGS_MODULE=config.prod_settings
      - DJP_PLUGINS_DIR=django_plugins
      - WEB_CONCURRENCY=4
      - REDIS_URL=redis://redis:6379
    command: gunicorn config.asgi:application -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --max-requests 200 --max-requests-jitter 50 --timeout 30 --graceful-timeout 10 --worker-tmp-dir /dev/shm
    ports:
      - 9000:8000
    depends_on:
      - redis
  anubis_django_green:
    image: ghcr.io/techarohq/anubis:latest
    environment:
      BIND: ":8001"
      DIFFICULTY: "3"
      METRICS_BIND: ":9020"
      TARGET: "http://django_green:8000"
      OG_PASSTHROUGH: "true"
      USE_REMOTE_ADDRESS: "true"
    ports:
      - 8001:8001
    volumes:
      - "./botPolicy.yaml:/data/cfg/botPolicy.yaml:ro"
  django_green:
    image: ghcr.io/civicband/corkboard:${VERSION:-latest}
    # Code is baked into the image - no local build or volume mount
    volumes:
      # Only mount data, not code
      - ../sites:/sites/
      - ./sites.db:/app/sites.db:ro
    env_file:
      - .env
    environment:
      - DJANGO_SETTINGS_MODULE=config.prod_settings
      - DJP_PLUGINS_DIR=django_plugins
      - WEB_CONCURRENCY=4
      - REDIS_URL=redis://redis:6379
    command: gunicorn config.asgi:application -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --max-requests 200 --max-requests-jitter 50 --timeout 30 --graceful-timeout 10 --worker-tmp-dir /dev/shm
    ports:
      - 9001:8000
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

volumes:
  redis_data:
