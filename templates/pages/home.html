{% extends "pages/base.html" %}

{% block content %}
<!-- Compact Header -->
<div class="border-b border-gray-200 bg-white">
  <div class="mx-auto max-w-7xl px-4 py-3 sm:px-6 lg:px-8">
    <!-- Navigation -->
    <nav class="mb-2">
      <ul class="flex flex-wrap gap-2 text-sm">
        <li><a href="/how.html" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_nav" data-umami-event-target="how">How it works</a></li>
        <li><a href="/why.html" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_nav" data-umami-event-target="why">Why?</a></li>
        <li><a href="/rss.xml" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_nav" data-umami-event-target="rss">RSS Feed</a></li>
        <li><a rel="me" href="https://sfba.social/@civicband" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_social" data-umami-event-platform="mastodon">Mastodon</a></li>
        <li><a rel="me" href="https://bsky.app/profile/civic.band" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_social" data-umami-event-platform="bluesky">Bluesky</a></li>
        <li><a href="https://opencollective.com/civicband" class="bg-indigo-500 text-white hover:bg-indigo-600 px-2 py-0.5 rounded font-medium transition" data-umami-event="homepage_support">Support!</a></li>
      </ul>
    </nav>

    <!-- Title and Description -->
    <h1 class="text-2xl font-bold text-gray-900 mb-1">CivicBand</h1>
    <div class="text-sm text-gray-700 space-y-1.5">
      <p>The largest collection of civic meeting data in the United States and Canada. A project from the <a href="https://raft.foundation" class="text-indigo-600 hover:text-indigo-800 underline" data-umami-event="homepage_external" data-umami-event-target="raft-foundation">Raft Foundation</a>. Email hello @ civic dot band with questions.</p>

      <!-- Newsletter Form -->
      <form action="https://buttondown.com/api/emails/embed-subscribe/civicband"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://buttondown.com/civicband', 'popupwindow')"
            class="flex flex-wrap gap-2 items-center">
        <label for="bd-email" class="sr-only">Email address</label>
        <input id="bd-email" name="email" type="email" autocomplete="email" required
               class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
               placeholder="Enter your email">
        <button type="submit"
                class="px-2 py-1 text-sm bg-indigo-500 text-white rounded hover:bg-indigo-600 font-medium transition"
                data-umami-event="homepage_newsletter">Subscribe</button>
        <span class="text-xs text-gray-600">
          We care about your data. Read our <a href="/privacy.html" class="text-indigo-600 hover:text-indigo-800 underline" data-umami-event="homepage_nav" data-umami-event-target="privacy">privacy policy</a>.
        </span>
      </form>

      <!-- Stats -->
      <h3 class="text-base font-semibold text-gray-900">
        {% load humanize %}Tracking {{ total_pages|default:0|intcomma }} pages across {{ num_sites|default:0|intcomma }} municipalities
      </h3>
    </div>
  </div>
</div>

<!-- Compact Search and Filters -->
<div class="bg-gray-50 border-b border-gray-200">
  <div class="mx-auto max-w-7xl px-4 py-2 sm:px-6 lg:px-8">
    <div class="flex flex-wrap gap-2 items-center text-sm">
      <!-- Search -->
      <input type="text"
             name="q"
             id="search-input"
             value="{{ query }}"
             placeholder="Search municipalities..."
             class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]"
             hx-get="/sites/search/"
             hx-trigger="keyup changed delay:300ms"
             hx-target="#sites-content"
             hx-include="[name='state'], [name='kind'], [name='sort']"
             hx-push-url="true">

      <!-- State Filter -->
      <select name="state"
              id="state-filter"
              class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              hx-get="/sites/search/"
              hx-trigger="change"
              hx-target="#sites-content"
              hx-include="[name='q'], [name='kind'], [name='sort']"
              hx-push-url="true">
        <option value="">All states</option>
        {% for st in states %}
        <option value="{{ st }}" {% if st == state %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>

      <!-- Kind Filters -->
      <div class="flex gap-1">
        <button type="button"
                class="px-2 py-1 text-xs rounded {% if not kind %}bg-indigo-500 text-white{% else %}bg-white text-gray-700 border border-gray-300 hover:bg-gray-50{% endif %}"
                hx-get="/sites/search/?kind="
                hx-trigger="click"
                hx-target="#sites-content"
                hx-include="[name='q'], [name='state'], [name='sort']"
                hx-push-url="true">All</button>
        <button type="button"
                class="px-2 py-1 text-xs rounded {% if kind == 'city' %}bg-indigo-500 text-white{% else %}bg-white text-gray-700 border border-gray-300 hover:bg-gray-50{% endif %}"
                hx-get="/sites/search/?kind=city"
                hx-trigger="click"
                hx-target="#sites-content"
                hx-include="[name='q'], [name='state'], [name='sort']"
                hx-push-url="true">Cities</button>
        <button type="button"
                class="px-2 py-1 text-xs rounded {% if kind == 'county' %}bg-indigo-500 text-white{% else %}bg-white text-gray-700 border border-gray-300 hover:bg-gray-50{% endif %}"
                hx-get="/sites/search/?kind=county"
                hx-trigger="click"
                hx-target="#sites-content"
                hx-include="[name='q'], [name='state'], [name='sort']"
                hx-push-url="true">Counties</button>
      </div>

      <span class="text-gray-400 hidden sm:inline">|</span>

      <!-- Sort Filters -->
      <div class="flex gap-1">
        <button type="button"
                class="px-2 py-1 text-xs rounded {% if sort == 'pages' %}bg-gray-200 text-gray-900{% else %}text-gray-600 hover:bg-gray-100{% endif %}"
                hx-get="/sites/search/?sort=pages"
                hx-trigger="click"
                hx-target="#sites-content"
                hx-include="[name='q'], [name='state'], [name='kind']"
                hx-push-url="true">Most pages</button>
        <button type="button"
                class="px-2 py-1 text-xs rounded {% if sort == 'last_updated' %}bg-gray-200 text-gray-900{% else %}text-gray-600 hover:bg-gray-100{% endif %}"
                hx-get="/sites/search/?sort=last_updated"
                hx-trigger="click"
                hx-target="#sites-content"
                hx-include="[name='q'], [name='state'], [name='kind']"
                hx-push-url="true">Recently updated</button>
      </div>
    </div>
  </div>
</div>

<!-- Content: Table first on mobile, side-by-side on desktop -->
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4">
  <div id="sites-content">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Table Column - Full width on mobile, 2/3 on desktop -->
      <div class="lg:col-span-2">
        <div id="sites-table-container">
          {% include 'pages/_sites_table.html' %}
        </div>
      </div>

      <!-- Map Column - Below table on mobile, 1/3 on desktop -->
      <div class="lg:col-span-1">
        <div id="sites-map" class="h-64 lg:h-[600px] rounded border border-gray-200 lg:sticky lg:top-4"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize map
const map = L.map('sites-map').setView([39.8283, -98.5795], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors',
  maxZoom: 19
}).addTo(map);

const markers = L.markerClusterGroup();
markers.addTo(map);

// Load initial markers
function loadMarkers(geojson) {
  markers.clearLayers();

  if (!geojson || !geojson.features || geojson.features.length === 0) {
    map.setView([39.8283, -98.5795], 4);
    return;
  }

  L.geoJSON(geojson, {
    onEachFeature: function(feature, layer) {
      if (feature.properties && feature.properties.popup) {
        layer.bindPopup(feature.properties.popup);
      }
      layer.on('click', function() {
        if (feature.properties && feature.properties.link) {
          window.location.href = feature.properties.link;
        }
      });
    }
  }).addTo(markers);

  if (markers.getLayers().length > 0) {
    map.fitBounds(markers.getBounds(), { padding: [50, 50] });
  }
}

// Listen for HTMX updates and initial load
// The sites:updated event is fired by _map_data.html on both initial load and HTMX updates
document.body.addEventListener('sites:updated', function(event) {
  loadMarkers(event.detail);
});
</script>
{% endblock %}
