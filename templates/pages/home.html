{% extends "pages/base.html" %}

{% block content %}
<!-- Compact Header -->
<div class="bg-white border-b-2 border-gray-300">
  <div class="mx-auto max-w-7xl px-4 py-3 sm:px-6 lg:px-8">
    <!-- Navigation -->
    <nav class="mb-3 pb-2 border-b border-gray-200">
      <ul class="flex flex-wrap gap-2 text-sm">
        <li><a href="/how.html" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_nav" data-umami-event-target="how">How it works</a></li>
        <li><a href="/why.html" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_nav" data-umami-event-target="why">Why?</a></li>
        <li><a href="/rss.xml" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_nav" data-umami-event-target="rss">RSS Feed</a></li>
        <li><a rel="me" href="https://sfba.social/@civicband" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_social" data-umami-event-platform="mastodon">Mastodon</a></li>
        <li><a rel="me" href="https://bsky.app/profile/civic.band" class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-0.5 rounded transition" data-umami-event="homepage_social" data-umami-event-platform="bluesky">Bluesky</a></li>
        <li><a href="https://opencollective.com/civicband" class="bg-indigo-500 text-white hover:bg-indigo-600 px-2 py-0.5 rounded font-medium transition" data-umami-event="homepage_support">Support!</a></li>
      </ul>
    </nav>

    <!-- Title and Description -->
    <h1 class="text-2xl font-bold text-gray-900 mb-2">CivicBand</h1>
    <div class="text-sm text-gray-700 space-y-2">
      <p>The largest collection of civic meeting data in the United States and Canada. A project from the <a href="https://raft.foundation" class="text-indigo-600 hover:text-indigo-800 underline" data-umami-event="homepage_external" data-umami-event-target="raft-foundation">Raft Foundation</a>. Email hello @ civic dot band with questions.</p>

      <!-- Newsletter Form -->
      <form action="https://buttondown.com/api/emails/embed-subscribe/civicband"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://buttondown.com/civicband', 'popupwindow')"
            class="flex flex-wrap gap-2 items-center">
        <label for="bd-email" class="sr-only">Email address</label>
        <input id="bd-email" name="email" type="email" autocomplete="email" required
               class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
               placeholder="Enter your email">
        <button type="submit"
                class="px-2 py-1 text-sm bg-indigo-500 text-white rounded hover:bg-indigo-600 font-medium transition"
                data-umami-event="homepage_newsletter">Subscribe</button>
        <span class="text-xs text-gray-600">
          We care about your data. Read our <a href="/privacy.html" class="text-indigo-600 hover:text-indigo-800 underline" data-umami-event="homepage_nav" data-umami-event-target="privacy">privacy policy</a>.
        </span>
      </form>

      <!-- Stats -->
      <h3 class="text-base font-semibold text-gray-900">
        {% load humanize %}Tracking {{ total_pages|default:0|intcomma }} pages across {{ num_sites|default:0|intcomma }} municipalities
      </h3>
    </div>
  </div>
</div>

<!-- Compact Search and Filters -->
<div class="bg-gray-100 border-b border-gray-300">
  <div class="mx-auto max-w-7xl px-4 py-3 sm:px-6 lg:px-8">
    <div class="flex flex-wrap gap-2 items-center text-sm">
      <!-- Search -->
      <input type="text"
             name="q"
             id="search-input"
             value="{{ query }}"
             placeholder="Search municipalities..."
             class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]"
             hx-get="/sites/search/"
             hx-trigger="keyup changed delay:300ms"
             hx-target="#sites-table-container"
             hx-include="[name='state'], [name='kind'], [name='sort']"
             hx-push-url="true">

      <!-- State Filter -->
      <select name="state"
              id="state-filter"
              class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              hx-get="/sites/search/"
              hx-trigger="change"
              hx-target="#sites-table-container"
              hx-include="[name='q'], [name='kind'], [name='sort']"
              hx-push-url="true">
        <option value="">All states</option>
        {% for st in states %}
        <option value="{{ st }}" {% if st == state %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>

      <!-- Type Filter -->
      <select name="kind"
              id="kind-filter"
              class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              hx-get="/sites/search/"
              hx-trigger="change"
              hx-target="#sites-table-container"
              hx-include="[name='q'], [name='state'], [name='sort']"
              hx-push-url="true">
        <option value="">All types</option>
        {% for k in kinds %}
        <option value="{{ k }}" {% if k == kind %}selected{% endif %}>{{ k|title }}</option>
        {% endfor %}
      </select>

      <!-- Clear Filters Button -->
      <button type="button"
              id="clear-filters-btn"
              class="px-2 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200 border border-red-300"
              style="display: {% if query or state or kind %}inline-block{% else %}none{% endif %};"
              onclick="document.getElementById('search-input').value=''; document.getElementById('state-filter').value=''; document.getElementById('kind-filter').value=''; this.style.display='none';"
              hx-get="/sites/search/"
              hx-trigger="click"
              hx-target="#sites-table-container"
              hx-push-url="true">Clear filters</button>
    </div>
  </div>
</div>

<!-- Content -->
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Table Column - HTMX replaces this -->
    <div class="lg:col-span-2 order-2 lg:order-1">
      <div id="sites-table-container">
        {% include 'pages/_sites_table_only.html' %}
      </div>
    </div>

    <!-- Map Column - Static, never replaced -->
    <div class="lg:col-span-1 order-1 lg:order-2">
      <div id="sites-map" class="h-64 lg:h-[600px] rounded border border-gray-200 lg:sticky lg:top-4"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
  // Initialize map with error handling
  let map, markers;

  try {
    map = L.map('sites-map').setView([39.8283, -98.5795], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    markers = L.markerClusterGroup();
    markers.addTo(map);
  } catch (error) {
    console.error('Failed to initialize map:', error);
    return;
  }

  // Load markers with robust error handling
  function loadMarkers(geojson) {
    if (!map || !markers) {
      console.warn('Map not initialized, cannot load markers');
      return;
    }

    try {
      // Clear existing markers
      markers.clearLayers();

      // Validate GeoJSON data
      if (!geojson || typeof geojson !== 'object') {
        console.warn('Invalid geojson data:', geojson);
        map.setView([39.8283, -98.5795], 4);
        return;
      }

      if (!geojson.features || !Array.isArray(geojson.features)) {
        console.warn('GeoJSON missing features array:', geojson);
        map.setView([39.8283, -98.5795], 4);
        return;
      }

      if (geojson.features.length === 0) {
        map.setView([39.8283, -98.5795], 4);
        return;
      }

      // Add GeoJSON to map
      L.geoJSON(geojson, {
        onEachFeature: function(feature, layer) {
          if (feature.properties && feature.properties.popup) {
            layer.bindPopup(feature.properties.popup);
          }
          layer.on('click', function() {
            if (feature.properties && feature.properties.link) {
              window.location.href = feature.properties.link;
            }
          });
        }
      }).addTo(markers);

      // Fit bounds if we have markers
      if (markers.getLayers().length > 0) {
        map.fitBounds(markers.getBounds(), { padding: [50, 50] });
      }
    } catch (error) {
      console.error('Failed to load markers:', error);
      // Reset to default view on error
      try {
        map.setView([39.8283, -98.5795], 4);
      } catch (e) {
        console.error('Failed to reset map view:', e);
      }
    }
  }

  // Listen for HTMX updates
  document.body.addEventListener('sites:updated', function(event) {
    loadMarkers(event.detail);
  });

  // Load initial data if available (from _map_data.html)
  // Wait a bit to ensure DOM is ready
  setTimeout(function() {
    if (window.sitesGeoJSON) {
      loadMarkers(window.sitesGeoJSON);
    }
  }, 100);
})();

// Update clear filters button visibility
(function() {
  const clearBtn = document.getElementById('clear-filters-btn');
  const searchInput = document.getElementById('search-input');
  const stateFilter = document.getElementById('state-filter');
  const kindFilter = document.getElementById('kind-filter');

  function updateClearButton() {
    const hasFilters = searchInput.value || stateFilter.value || kindFilter.value;
    clearBtn.style.display = hasFilters ? 'inline-block' : 'none';
  }

  // Check on input changes
  searchInput.addEventListener('input', updateClearButton);
  stateFilter.addEventListener('change', updateClearButton);
  kindFilter.addEventListener('change', updateClearButton);

  // Also check after HTMX requests complete
  document.body.addEventListener('htmx:afterSwap', updateClearButton);
})();
</script>
{% endblock %}
